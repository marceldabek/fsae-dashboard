import{r as x,g as Ue,j as t,s as Xe,S as ye,E as Ve,a as Te,b as _e,d as Pe,T as Ge}from"./index-QG0Np7WM.js";import{P as Je}from"./ProjectCreateModal-CcXecLhk.js";import{u as Ke,d as Re}from"./discordMapping-DhJR_OXb.js";import"./PersonSelectPopover-CRffLPmv.js";/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=s=>s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),qe=s=>s.replace(/^([A-Z])|[\s-_]+(\w)/g,(r,u,g)=>g?g.toUpperCase():u.toLowerCase()),Ye=s=>{const r=qe(s);return r.charAt(0).toUpperCase()+r.slice(1)},Oe=(...s)=>s.filter((r,u,g)=>!!r&&r.trim()!==""&&g.indexOf(r)===u).join(" ").trim(),Qe=s=>{for(const r in s)if(r.startsWith("aria-")||r==="role"||r==="title")return!0};/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var et={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tt=x.forwardRef(({color:s="currentColor",size:r=24,strokeWidth:u=2,absoluteStrokeWidth:g,className:j="",children:p,iconNode:y,...c},w)=>x.createElement("svg",{ref:w,...et,width:r,height:r,stroke:s,strokeWidth:g?Number(u)*24/Number(r):u,className:Oe("lucide",j),...!p&&!Qe(c)&&{"aria-hidden":"true"},...c},[...y.map(([k,R])=>x.createElement(k,R)),...Array.isArray(p)?p:[p]]));/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nt=(s,r)=>{const u=x.forwardRef(({className:g,...j},p)=>x.createElement(tt,{ref:p,iconNode:r,className:Oe(`lucide-${Ze(Ye(s))}`,`lucide-${s}`,g),...j}));return u.displayName=Ye(s),u};/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ot=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],st=nt("info",ot),Me=["January","February","March","April","May","June","July","August","September","October","November","December"],rt=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function Be(s,r){return new Date(s,r+1,0).getDate()}function ke(s){return`${s.getMonth()+1}/${s.getDate()}`}function F(s){const r=new Date(s);if(isNaN(+r))throw new Error("Invalid date: "+s);return r}function at(s=new Date){const r=s.getFullYear(),g=s.getMonth()>=7?r:r-1,j=new Date(g,7,1),p=[];for(let y=7;y<=11;y++){const c=new Date(g,y,1);p.push({idx:p.length,year:c.getFullYear(),month:c.getMonth(),name:Me[c.getMonth()].toUpperCase().slice(0,3),start:c,days:Be(c.getFullYear(),c.getMonth())})}for(let y=0;y<=5;y++){const c=new Date(g+1,y,1);p.push({idx:p.length,year:c.getFullYear(),month:c.getMonth(),name:Me[c.getMonth()].toUpperCase().slice(0,3),start:c,days:Be(c.getFullYear(),c.getMonth())})}return{start:j,months:p}}const be={done:"#34D399",wip:"hsl(var(--accent))",blocked:"#BDC0C3"};function Fe(s){const r=s||[];return r.length?r.every(u=>u.status==="Complete"):!1}function He(s){if(!s)return null;const r=new Date(s);return isNaN(+r)?null:r.toISOString()}function ct(){const[s,r]=x.useState(null),[u,g]=x.useState(null),[j,p]=x.useState(!0),[y,c]=x.useState(null),[w,k]=x.useState(null),{members:R}=Ke();x.useEffect(()=>{let f=!0;return(async()=>{try{const[M,_,m]=await Promise.all([Te(),_e(),Pe()]);if(!f)return;k(Re(R));const S=new Map;for(const a of _){const h=S.get(a.project_id)||[];h.push(a),S.set(a.project_id,h)}const C=m.filter(a=>!!a.from_id&&!!a.to_id).map(a=>({id:a.id,fromId:a.from_id,toId:a.to_id})),$=new Set,D=[];for(const a of C){const h=`${a.fromId}|${a.toId}`;$.has(h)||($.add(h),D.push(a))}const I=new Map;D.forEach(a=>{I.has(a.toId)||I.set(a.toId,[]),I.get(a.toId).push(a.fromId)});const B=new Set;for(const a of M)a.archived||Fe(S.get(a.id))&&B.add(a.id);const n=M.filter(a=>!a.archived).map(a=>{const h=He(a.due_date);if(!h)return null;const T=B.has(a.id);let P;return T?P="done":P=(I.get(a.id)||[]).some(X=>!B.has(X))?"blocked":"wip",{id:a.id,name:a.name,dueDate:h,status:P}}).filter(Boolean);r(n),g(D)}catch(M){if(!f)return;c(M?.message||"Failed to load timeline")}finally{f&&p(!1)}})(),()=>{f=!1}},[R]);async function N(f,M){if(f!==M)try{const _=await Ge({from_id:f,to_id:M});g(m=>{const S=m||[];return S.some(C=>C.fromId===f&&C.toId===M)?S:[...S,{id:_,fromId:f,toId:M}]})}catch{}}async function L(){try{p(!0);const[f,M,_]=await Promise.all([Te(),_e(),Pe()]);k(Re(R));const m=new Map;for(const n of M){const a=m.get(n.project_id)||[];a.push(n),m.set(n.project_id,a)}const S=_.filter(n=>!!n.from_id&&!!n.to_id).map(n=>({id:n.id,fromId:n.from_id,toId:n.to_id})),C=new Set,$=[];for(const n of S){const a=`${n.fromId}|${n.toId}`;C.has(a)||(C.add(a),$.push(n))}const D=new Map;$.forEach(n=>{D.has(n.toId)||D.set(n.toId,[]),D.get(n.toId).push(n.fromId)});const I=new Set;for(const n of f)n.archived||Fe(m.get(n.id))&&I.add(n.id);const B=f.filter(n=>!n.archived).map(n=>{const a=He(n.due_date);if(!a)return null;const h=I.has(n.id);let T;return h?T="done":T=(D.get(n.id)||[]).some(b=>!I.has(b))?"blocked":"wip",{id:n.id,name:n.name,dueDate:a,status:T}}).filter(Boolean);r(B),g($)}finally{p(!1)}}return{projects:s,setProjects:r,dependencies:u,setDependencies:g,loading:j,error:y,createDependency:N,people:w,refreshAll:L}}function dt(s,r,u){const{monthWidth:g,rowHeight:j,block:p,headerH:y}=u;if(!s)return{items:new Map,containerH:y+j*8};const c=new Map,w={};s.forEach(N=>{const L=F(N.dueDate),f=r.findIndex(I=>L.getFullYear()===I.year&&L.getMonth()===I.month);if(f===-1)return;const M=L.getDate();w[f]||(w[f]={});const _=w[f][M]!==void 0?w[f][M]:0;w[f][M]=_+1;const m=r[f],S=g/m.days,$=g*f+S*(M-1)+Math.max(0,(S-p.w)/2),D=y+_*j;c.set(N.id,{id:N.id,x:$,y:D,w:p.w,h:p.h,monthIdx:f})});let k=1;Object.values(w).forEach(N=>{Object.values(N).forEach(L=>{L>k&&(k=Math.max(k,L))})});const R=y+Math.max(3,k)*u.rowHeight+160;return{items:c,containerH:R}}function it(s,r){const{months:u}=at(),g=x.useMemo(()=>dt(s,u,r),[s,u,r.monthWidth,r.rowHeight,r.block.w,r.block.h,r.headerH]);return{months:u,layout:g}}function We({items:s,dependencies:r,highlightId:u,monthWidth:g,months:j}){const p=g*j.length;let y=0;s.forEach(n=>{y=Math.max(y,n.y+n.h)});const c=y+12,w=r.filter(n=>s.has(n.fromId)&&s.has(n.toId)),k=[];s.forEach(n=>k.push(n.y+n.h)),k.sort((n,a)=>n-a);const R=k.filter((n,a,h)=>a===0||n!==h[a-1]),N=n=>`${n.fromId}|${n.toId}`,L=new Map,f=new Map;w.forEach(n=>{s.get(n.fromId),s.get(n.toId),L.has(n.fromId)||L.set(n.fromId,[]),f.has(n.toId)||f.set(n.toId,[]),L.get(n.fromId).push(n),f.get(n.toId).push(n)}),L.forEach(n=>n.sort((a,h)=>s.get(a.toId).x-s.get(h.toId).x||a.toId.localeCompare(h.toId))),f.forEach(n=>n.sort((a,h)=>s.get(a.fromId).x-s.get(h.fromId).x||a.fromId.localeCompare(h.fromId)));const M=new Map,_=new Map,m=new Map,S=new Map;L.forEach((n,a)=>{_.set(a,n.length),n.forEach((h,T)=>M.set(N(h),T))}),f.forEach((n,a)=>{S.set(a,n.length),n.forEach((h,T)=>m.set(N(h),T))});const C=14,$=14,D=w.map((n,a)=>{const h=s.get(n.fromId),T=s.get(n.toId),P=h.x+h.w,Q=T.x,b=N(n),X=_.get(n.fromId)||1,ee=M.get(b)||0,me=S.get(n.toId)||1,te=m.get(b)||0,J=(ee-(X-1)/2)*C,ae=(te-(me-1)/2)*C,ne=h.y+(ee+1)/(X+1)*h.h,A=T.y+(te+1)/(me+1)*T.h;let O=P+$+J;const K=Q-$-ae,fe=Math.min(O,K),we=Math.max(O,K);let oe=Math.max(h.y+h.h,T.y+T.h);s.forEach(z=>{const Z=z.x;z.x+z.w<fe||Z>we||(oe=Math.max(oe,z.y+z.h))});const E=oe+8,ce=(X-ee)*18;O=Math.min(O+ce,K-16);const de=K<=O+2,xe=E>Math.max(ne,A)+6||de?`M ${P} ${ne} H ${O} V ${E} H ${K} V ${A} H ${Q}`:`M ${P} ${ne} H ${K} V ${A} H ${Q}`,se=!!(u&&(n.fromId===u||n.toId===u));return t.jsx("path",{d:xe,stroke:se?"hsl(var(--accent))":"rgb(var(--overlay-10))",strokeWidth:se?3:2.5,fill:"none",strokeLinecap:"round",strokeLinejoin:"round",opacity:se?1:.9},a)}),I=R.map(n=>n+8),B=Math.max(c+24,(I[I.length-1]||c)+24);return t.jsx("svg",{width:p,height:B,className:"absolute left-0 top-0 pointer-events-none z-0",children:D})}function lt({months:s,monthWidth:r,onPickMonth:u}){return t.jsx("div",{className:"sticky top-0 z-10 bg-card/80 dark:bg-surface/80 backdrop-blur border-b border-border",children:t.jsx("div",{className:"relative",style:{width:r*s.length},children:s.map((g,j)=>t.jsx("div",{className:"inline-flex items-center justify-center font-medium text-sm uppercase tracking-wide text-mutedToken-foreground hover:bg-surface/60 cursor-pointer select-none",style:{width:r,height:36},onClick:()=>{u&&u(j)},children:g.name},j))})})}function ut(){return t.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-[11px] text-mutedToken-foreground leading-snug",children:[t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx("span",{className:"w-2.5 h-2.5 rounded-sm",style:{background:be.done}})," done"]}),t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx("span",{className:"w-2.5 h-2.5 rounded-sm",style:{background:be.wip}})," active"]}),t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx("span",{className:"w-2.5 h-2.5 rounded-sm",style:{background:be.blocked}})," blocked"]}),t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx("span",{className:"w-2.5 h-2.5 rounded-sm",style:{background:"rgb(var(--overlay-10))"}})," deps"]}),t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx("span",{className:"w-2.5 h-2.5 rounded-sm",style:{background:"hsl(var(--accent))"}})," highlight"]})]})}function ht({canEdit:s}){const[r,u]=x.useState(!1);return t.jsxs("div",{className:"relative inline-flex items-center group",onMouseEnter:()=>u(!0),onMouseLeave:()=>u(!1),children:[t.jsx("div",{className:"p-1 rounded group-hover:bg-surface/60","aria-label":"Info",children:t.jsx(st,{size:16,className:"text-mutedToken-foreground"})}),r&&t.jsxs("div",{className:"absolute top-full left-0 mt-2 w-64 rounded-md border border-border bg-card dark:bg-surface shadow-2xl p-3 z-50 animate-in fade-in zoom-in-95",children:[t.jsx("div",{className:"text-xs font-semibold mb-2",children:"Legend"}),t.jsx(ut,{}),t.jsx("div",{className:"h-px my-2 bg-border"}),t.jsxs("div",{className:"text-[11px] leading-snug text-mutedToken-foreground space-y-1",children:[t.jsx("div",{children:"Click a project: highlight edges"}),t.jsx("div",{children:"Double-click a project: open details"}),s&&t.jsx("div",{children:"Edit → Link: create dependency"})]})]})]})}function Ae({p:s,rect:r,selected:u,onClick:g,onDoubleClick:j,onMouseDown:p,onMouseUp:y,onMouseLeave:c,displayDueDateIso:w,elevate:k}){const R=be[s.status],N=F(w||s.dueDate);return t.jsxs("div",{role:"button",onClick:g,onDoubleClick:j,onMouseDown:p,onMouseUp:y,onMouseLeave:c,className:`absolute rounded shadow-sm border border-black/50 dark:border-white/40 overflow-hidden text-black dark:text-white hover:scale-[1.02] transition-transform ${u?"ring-2 ring-[hsl(var(--accent))]":""}`,style:{left:r.x,top:r.y,width:r.w,height:r.h,background:R,zIndex:k?50:10},title:`${s.name} - due ${ke(N)}`,children:[t.jsx("div",{className:"absolute top-0.5 right-1 text-[9px] font-semibold leading-none text-black/80 dark:text-white/90 select-none",children:ke(N)}),t.jsx("div",{className:"absolute inset-0 grid place-items-center px-1.5 pt-3 pb-1.5 text-center",children:t.jsx("div",{className:"text-[11px] leading-tight break-words",style:{display:"-webkit-box",WebkitLineClamp:3,WebkitBoxOrient:"vertical",overflow:"hidden"},children:s.name})}),s.milestone&&t.jsx("div",{className:"absolute -top-5 left-1/2 -translate-x-1/2 text-[10px] bg-black text-white px-1.5 py-[2px] rounded",children:ke(N)})]})}const re="__ARMED__";function bt(){const{role:s}=Ue(),r=s==="admin"||s==="lead",{projects:u,setProjects:g,dependencies:j,setDependencies:p,loading:y,error:c,createDependency:w,people:k,refreshAll:R}=ct(),[N,L]=x.useState(""),f=e=>{L(e),window.setTimeout(()=>L(""),2500)},[M,_]=x.useState(!1),[m,S]=x.useState({kind:"year"}),[C,$]=x.useState(null),[D,I]=x.useState(null),[B,n]=x.useState(!1),a=B?"Linking...":"Link",h=640,T=74,P={w:104,h:56},Q=56,{months:b,layout:X}=it(u,{monthWidth:h,rowHeight:T,block:P,headerH:Q}),ee=h*b.length,me=e=>`${Me[b[e].month]} ${b[e].year}`,te=x.useMemo(()=>new Map((u||[]).map(e=>[e.id,e])),[u]),J=new Date,ae=x.useRef(null),ne=x.useRef(null),A=x.useRef(!1);x.useEffect(()=>{const e=ae.current,o=ne.current;if(!e||!o)return;const d=()=>{A.current||(A.current=!0,o.scrollLeft=e.scrollLeft,A.current=!1)},i=()=>{A.current||(A.current=!0,e.scrollLeft=o.scrollLeft,A.current=!1)};return e.addEventListener("scroll",d,{passive:!0}),o.addEventListener("scroll",i,{passive:!0}),()=>{e.removeEventListener("scroll",d),o.removeEventListener("scroll",i)}},[m,ee]);const[O,K]=x.useState(0),fe=x.useRef(null),we=m.kind==="month"?b[m.monthIdx].days:0,oe=56,E=m.kind==="month"&&O?Math.max(oe,Math.floor(O/we)):oe,ce=m.kind==="month"?E*b[m.monthIdx].days:0,de=x.useMemo(()=>{if(!u||m.kind!=="month")return[];const e=b[m.monthIdx];return u.filter(o=>{const d=F(o.dueDate);return d.getFullYear()===e.year&&d.getMonth()===e.month}).sort((o,d)=>F(o.dueDate).getDate()-F(d.dueDate).getDate()||o.id.localeCompare(d.id))},[u,m,b]),V=x.useMemo(()=>{if(m.kind!=="month")return new Map;const e=new Map,o={};return de.forEach(d=>{const i=F(d.dueDate).getDate(),l=o[i]!==void 0?o[i]:0;o[i]=l+1;const v=(i-1)*E+(E-P.w)/2,Y=70+l*60;e.set(d.id,{id:d.id,x:v,y:Y,w:P.w,h:P.h,monthIdx:m.monthIdx})}),e},[m,de,E,P.w,P.h]);async function xe(e){if(B&&r){if(D&&D!==re&&e!==D){const o=te.get(D),d=te.get(e);if(!o||!d){I(re);return}const i=F(o.dueDate),l=F(d.dueDate),v=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`,Y=`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`;if(v===Y){f("Links must move forward (different dates)."),I(re),$(e);return}const U=i<l?o:d,q=i<l?d:o,le=U.id,ue=q.id,$e=U.name,Ee=q.name,Le=j||[],je=Le.find(G=>G.fromId===le&&G.toId===ue),Ie=Le.find(G=>G.fromId===ue&&G.toId===le);if(je){try{je.id&&await ye(je.id)}catch{}p?.(G=>(G||[]).filter(he=>!(he.fromId===le&&he.toId===ue))),f(`Unlinked ${$e} — ${Ee}`)}else{if(Ie){try{Ie.id&&await ye(Ie.id)}catch{}p?.(G=>(G||[]).filter(he=>!(he.fromId===ue&&he.toId===le)))}await w(le,ue),f(`Linked ${$e} → ${Ee}`)}$(e),I(re);return}if(D===re){I(e),$(e);return}if(!D){I(e),$(e);return}if(D===e){$(e);return}}$(o=>o===e?null:e)}function se(e){window.location.assign(`/project/${e}`)}const z=x.useRef(null),Z=x.useRef(!1),H=x.useRef(null),[W,ie]=x.useState(null),ge=x.useRef(!1);function ve(){z.current&&(window.clearTimeout(z.current),z.current=null)}function De(e){const o=e.getFullYear(),d=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${o}-${d}-${i}`}function Ne(e){if(m.kind==="year"){const o=ae.current;if(!o)return new Date(F(H.current.startIso));const d=o.getBoundingClientRect(),i=e-d.left+o.scrollLeft,l=Math.max(0,Math.min(b.length-1,Math.floor(i/h))),v=b[l],Y=i-l*h,U=h/v.days,q=Math.max(0,Math.min(v.days-1,Math.round(Y/U)));return new Date(v.year,v.month,q+1)}else{const o=fe.current,d=m.monthIdx,i=b[d];if(!o)return new Date(i.year,i.month,new Date(F(H.current.startIso)).getDate());const l=o.getBoundingClientRect(),v=e-l.left+o.scrollLeft,Y=Math.max(0,Math.min(i.days-1,Math.round(v/E)));return new Date(i.year,i.month,Y+1)}}function Se(e,o){if(!r||B)return;ve();const d=te.get(o);if(!d)return;const i=d.dueDate;Z.current=!1,H.current={id:o,startClientX:e.clientX,startIso:i},z.current=window.setTimeout(()=>{Z.current=!0,ie({id:o,iso:i}),window.addEventListener("mousemove",Ce),window.addEventListener("mouseup",ze,{once:!0}),document.body.style.userSelect="none",document.body.style.cursor="ew-resize"},350)}function pe(){Z.current||(ve(),H.current=null)}function Ce(e){if(!Z.current||!H.current)return;const o=Ne(e.clientX),d=new Date(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate())).toISOString();ie(i=>i&&i.id===H.current.id?{id:i.id,iso:d}:{id:H.current.id,iso:d})}async function ze(e){ve();const o=Z.current&&!!H.current;Z.current=!1;const d=H.current;if(H.current=null,document.body.style.userSelect="",document.body.style.cursor="",window.removeEventListener("mousemove",Ce),!d){ie(null);return}if(!o){ie(null);return}ge.current=!0,window.setTimeout(()=>{ge.current=!1},250);const i=te.get(d.id);if(ie(null),!i)return;const l=Ne(e.clientX),v=De(F(i.dueDate)),Y=De(l);if(Y!==v)try{await Ve(d.id,{due_date:Y}),g?.(U=>U&&U.map(q=>q.id===d.id?{...q,dueDate:new Date(Date.UTC(l.getFullYear(),l.getMonth(),l.getDate())).toISOString()}:q)),f(`Due date moved to ${Y}`),setTimeout(()=>{R().catch(()=>{})},50)}catch{f("Failed to update due date")}}return c?t.jsxs("div",{className:"p-6 text-danger",children:["Failed to load timeline. ",String(c)]}):t.jsxs("div",{className:"w-full min-h-screen flex flex-col bg-background",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b border-border bg-card dark:bg-surface sticky top-0 z-40",children:[t.jsx("div",{className:"flex items-center gap-3",children:t.jsxs("h1",{className:"text-lg font-semibold flex items-center gap-1",children:[m.kind==="month"?me(m.monthIdx):"Timeline",t.jsx(ht,{canEdit:r})]})}),t.jsxs("div",{className:"flex items-center gap-2",children:[m.kind==="month"&&t.jsx("button",{className:"px-3 py-1.5 rounded border text-sm border-border bg-card dark:bg-surface",onClick:()=>S({kind:"year"}),children:"Back to Year View"}),r&&t.jsx(mt,{projects:u||[],dependencies:j||[],onDeleted:e=>p?.(o=>(o||[]).filter(d=>d.id&&d.id===e?!1:`${d.fromId}|${d.toId}`!==e))}),r&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"mx-2 w-px h-6 bg-border"}),t.jsx("button",{className:"px-3 py-1.5 rounded border text-sm border-accent/40 bg-accent/15 text-accent hover:bg-accent/25",onClick:()=>_(!0),"aria-label":"Create project",title:"Create project",children:"+ Project"}),t.jsx("div",{className:"mx-2 w-px h-6 bg-border"}),t.jsx("button",{className:B?"px-3 py-1.5 rounded border text-sm border-border bg-[hsl(var(--accent))] text-white":"px-3 py-1.5 rounded border text-sm border-border bg-card dark:bg-surface",onClick:()=>{B?(n(!1),I(null)):(n(!0),I(re))},children:a})]})]})]}),m.kind==="year"&&t.jsxs("div",{className:"flex-1 flex flex-col",children:[t.jsx("div",{ref:ae,className:"relative overflow-x-auto overflow-y-hidden flex-1",children:t.jsxs("div",{className:"relative",style:{width:ee,height:X.containerH,minHeight:"100vh"},children:[t.jsx(lt,{months:b,monthWidth:h,onPickMonth:e=>S({kind:"month",monthIdx:e})}),b.map((e,o)=>t.jsx("div",{className:"absolute border-r border-border",style:{left:o*h,top:0,height:"100vh",width:0}},o)),(()=>{const e=b.findIndex(l=>l.year===J.getFullYear()&&l.month===J.getMonth());if(e===-1)return null;const o=b[e],d=h/o.days,i=e*h+(J.getDate()-1)*d+d/2;return t.jsx("div",{className:"absolute top-0 bottom-0",style:{left:i,width:0},children:t.jsx("div",{className:"absolute top-0 bottom-0 border-r",style:{borderColor:"#E11D48"}})})})(),(u||[]).map(e=>{let o=X.items.get(e.id);if(!o)return null;if(W?.id===e.id)try{const d=F(W.iso),i=b.findIndex(l=>d.getFullYear()===l.year&&d.getMonth()===l.month);if(i!==-1){const l=b[i],v=h/l.days,U=h*i+v*(d.getDate()-1)+Math.max(0,(v-o.w)/2);o={...o,x:U}}}catch{}return t.jsx(Ae,{p:e,rect:o,selected:C===e.id,onClick:()=>{ge.current||xe(e.id)},onDoubleClick:()=>se(e.id),onMouseDown:d=>Se(d,e.id),onMouseUp:pe,onMouseLeave:pe,displayDueDateIso:W?.id===e.id?W.iso:void 0,elevate:C===e.id||W?.id===e.id},e.id)}),t.jsx(We,{items:X.items,dependencies:j||[],highlightId:C,monthWidth:h,months:b})]})}),t.jsx("div",{className:"border-t border-border",children:t.jsx("div",{ref:ne,className:"overflow-x-auto overflow-y-hidden h-4",style:{scrollbarGutter:"stable both-edges"},children:t.jsx("div",{style:{width:ee,height:1}})})})]}),m.kind==="month"&&t.jsx("div",{className:"relative overflow-x-auto overflow-y-hidden flex-1",ref:e=>{if(!e)return;fe.current=e,new ResizeObserver(d=>{for(const i of d){const l=Math.floor(i.contentRect.width);l&&l!==O&&K(l)}}).observe(e)},children:t.jsxs("div",{className:"relative",style:{width:ce,height:520},children:[Array.from({length:b[m.monthIdx].days}).map((e,o)=>{const i=new Date(b[m.monthIdx].year,b[m.monthIdx].month,o+1).getDay(),l=rt[i],v=i===2||i===4||i===6;return t.jsxs(Xe.Fragment,{children:[t.jsx("div",{className:"absolute top-0 bottom-0"+(v?" bg-accent/5":""),style:{left:o*E,width:E,zIndex:0,pointerEvents:"none"}}),t.jsx("div",{className:"absolute top-0 bottom-0 border-r border-border/40",style:{left:o*E,width:E,zIndex:0,pointerEvents:"none"}}),t.jsx("div",{className:"absolute top-0 bottom-0",style:{left:o*E,width:E,zIndex:0,pointerEvents:"none"},children:t.jsxs("div",{className:"sticky top-8 text-[10px] leading-tight text-center",children:[t.jsx("div",{className:"font-medium text-foreground/80",children:o+1}),t.jsx("div",{className:"uppercase tracking-wide "+(v?"text-accent":"text-mutedToken-foreground"),children:l})]})})]},o)}),(()=>{const e=b[m.monthIdx];if(J.getFullYear()!==e.year||J.getMonth()!==e.month)return null;const o=(J.getDate()-1)*E+E/2;return t.jsx("div",{className:"absolute top-0 bottom-0",style:{left:o,width:0},children:t.jsx("div",{className:"absolute top-0 bottom-0 border-r",style:{borderColor:"#E11D48"}})})})(),de.map(e=>{let o=V.get(e.id);if(!o)return null;if(W?.id===e.id)try{const l=(F(W.iso).getDate()-1)*E+(E-o.w)/2;o={...o,x:l}}catch{}return t.jsx(Ae,{p:e,rect:o,selected:C===e.id,onClick:()=>{ge.current||xe(e.id)},onDoubleClick:()=>se(e.id),onMouseDown:d=>Se(d,e.id),onMouseUp:pe,onMouseLeave:pe,displayDueDateIso:W?.id===e.id?W.iso:void 0,elevate:C===e.id||W?.id===e.id},e.id)}),(()=>{const e=new Map(V);b[m.monthIdx];const o=0,d=ce,i=(j||[]).filter(l=>{const v=V.has(l.fromId),Y=V.has(l.toId);return v||Y});return i.forEach(l=>{if(!e.has(l.fromId)&&V.has(l.toId)){const v=V.get(l.toId);e.set(l.fromId,{id:l.fromId,x:o,y:v.y,w:0,h:v.h,monthIdx:m.monthIdx})}if(!e.has(l.toId)&&V.has(l.fromId)){const v=V.get(l.fromId);e.set(l.toId,{id:l.toId,x:d,y:v.y,w:0,h:v.h,monthIdx:m.monthIdx})}}),t.jsx(We,{items:e,dependencies:i,highlightId:C,monthWidth:ce,months:b.slice(m.monthIdx,m.monthIdx+1)})})()]})}),y&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-mutedToken-foreground",children:"Loading timeline..."}),N&&t.jsx("div",{className:"fixed bottom-4 right-4 z-[100] px-3 py-2 rounded shadow-lg bg-accent/90 text-white text-sm border border-accent",children:N}),t.jsx(Je,{open:!!M&&!!k,onClose:()=>_(!1),people:k||[],onCreated:async()=>{await R(),f("Project created")}})]})}function mt({projects:s,dependencies:r,onDeleted:u}){const[g,j]=x.useState(!1),p=x.useMemo(()=>new Map(s.map(c=>[c.id,c])),[s]),y=[...r].map((c,w)=>({idx:w,id:c.id||`${c.fromId}|${c.toId}`,from:p.get(c.fromId)?.name||c.fromId,to:p.get(c.toId)?.name||c.toId})).sort((c,w)=>c.from.localeCompare(w.from)||c.to.localeCompare(w.to));return t.jsxs("div",{className:"relative inline-block",children:[t.jsx("button",{className:"px-3 py-1.5 rounded border text-sm border-border bg-card dark:bg-surface",onClick:()=>j(c=>!c),"aria-expanded":g,"aria-haspopup":!0,children:"Deps"}),g&&t.jsxs("div",{className:"absolute right-0 mt-1 w-[560px] max-h-[420px] overflow-auto rounded-md border border-border bg-card dark:bg-surface shadow-2xl z-50",children:[t.jsx("div",{className:"px-3 py-2 text-xs text-mutedToken-foreground border-b border-border sticky top-0 bg-card dark:bg-surface",children:"Dependencies"}),t.jsxs("ul",{className:"p-3 space-y-1",children:[y.length===0&&t.jsx("li",{className:"text-xs text-mutedToken-foreground px-2 py-1",children:"No dependencies yet."}),y.map(c=>t.jsxs("li",{className:"grid grid-cols-[1fr_auto_1fr_auto] items-center gap-2 text-xs px-2 py-1 rounded hover:bg-surface/70",children:[t.jsx("span",{className:"truncate",title:`${c.from}`,children:c.from}),t.jsx("span",{className:"text-center w-16 shrink-0",children:"→"}),t.jsx("span",{className:"truncate",title:`${c.to}`,children:c.to}),t.jsx("button",{className:"px-2 py-0.5 rounded border text-[11px] border-border bg-card dark:bg-surface hover:bg-card/70 justify-self-end",onClick:async()=>{try{if(c.id.includes("|")){const w=r.find(k=>`${k.fromId}|${k.toId}`===c.id);w?.id&&await ye(w.id),u(w?.id||c.id)}else await ye(c.id),u(c.id)}catch{}},children:"Delete"})]},c.id))]})]})]})}export{at as academicYearWindow,dt as computeYearLayout,bt as default};
